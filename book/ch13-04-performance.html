<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Comparing Performance: Loops vs. Iterators - The Rust Programming Language</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="ferris.css">
        <link rel="stylesheet" href="theme/2018-edition.css">
        <link rel="stylesheet" href="theme/semantic-notes.css">
        <link rel="stylesheet" href="theme/listing.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust Programming Language</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="so-sánh-hiệu-năng-vòng-lặp-vs-iterator"><a class="header" href="#so-sánh-hiệu-năng-vòng-lặp-vs-iterator">So sánh hiệu năng: Vòng lặp vs. Iterator</a></h2>
<p>Để quyết định nên dùng vòng lặp hay iterator, bạn cần biết phiên bản nào
nhanh hơn: phiên bản hàm <code>search</code> dùng vòng lặp <code>for</code> rõ ràng hay phiên bản
dùng iterator.</p>
<p>Chúng tôi đã chạy benchmark bằng cách tải toàn bộ nội dung <em>The Adventures of
Sherlock Holmes</em> của Sir Arthur Conan Doyle vào một <code>String</code> và tìm từ <em>the</em>
trong nội dung. Dưới đây là kết quả benchmark cho phiên bản <code>search</code> dùng
vòng lặp <code>for</code> và phiên bản dùng iterator:</p>
<pre><code class="language-text">test bench_search_for  ... bench:  19,620,300 ns/iter (+/- 915,700)
test bench_search_iter ... bench:  19,234,900 ns/iter (+/- 657,200)
</code></pre>
<p>Phiên bản dùng iterator nhanh hơn một chút! Chúng tôi sẽ không giải thích chi tiết mã benchmark ở đây, vì mục đích không phải là chứng minh hai phiên bản hoàn toàn tương đương, mà chỉ để có cái nhìn tổng quan về hiệu năng của hai cách triển khai này.</p>
<p>Để benchmark toàn diện hơn, bạn nên thử với nhiều loại văn bản có kích thước khác nhau làm <code>contents</code>, các từ khác nhau với độ dài khác nhau làm <code>query</code>, và nhiều biến thể khác. Ý chính là: iterator, mặc dù là một trừu tượng cao cấp, được biên dịch xuống gần như cùng một mã máy như nếu bạn tự viết mã cấp thấp. Iterator là một trong những <em>zero-cost abstractions</em> của Rust, nghĩa là sử dụng trừu tượng này không gây thêm chi phí runtime. Điều này tương tự cách Bjarne Stroustrup, nhà thiết kế và hiện thực C++ gốc, định nghĩa <em>zero-overhead</em> trong “Foundations of C++” (2012):</p>
<blockquote>
<p>In general, C++ implementations obey the zero-overhead principle: What you
don’t use, you don’t pay for. And further: What you do use, you couldn’t hand
code any better.</p>
</blockquote>
<p>Một ví dụ khác, đoạn mã sau lấy từ một bộ giải mã audio. Thuật toán giải mã sử dụng phép toán dự đoán tuyến tính để ước lượng các giá trị tương lai dựa trên hàm tuyến tính của các mẫu trước đó. Đoạn mã này sử dụng chuỗi iterator để tính toán trên ba biến trong phạm vi: một slice <code>buffer</code> chứa dữ liệu, một mảng 12 phần tử <code>coefficients</code>, và một lượng dịch dữ liệu trong <code>qlp_shift</code>. Chúng tôi đã khai báo các biến trong ví dụ này nhưng không gán giá trị; mặc dù mã này không có nhiều ý nghĩa ngoài ngữ cảnh của nó, nó vẫn là một ví dụ thực tế, cô đọng về cách Rust chuyển các ý tưởng cao cấp xuống mã cấp thấp.</p>
<pre><code class="language-rust ignore">let buffer: &amp;mut [i32];
let coefficients: [i64; 12];
let qlp_shift: i16;

for i in 12..buffer.len() {
    let prediction = coefficients.iter()
                                 .zip(&amp;buffer[i - 12..i])
                                 .map(|(&amp;c, &amp;s)| c * s as i64)
                                 .sum::&lt;i64&gt;() &gt;&gt; qlp_shift;
    let delta = buffer[i];
    buffer[i] = prediction as i32 + delta;
}</code></pre>
<p>Để tính giá trị của <code>prediction</code>, đoạn mã này lặp qua từng giá trị trong 12 phần tử của <code>coefficients</code> và sử dụng phương thức <code>zip</code> để ghép các giá trị hệ số với 12 giá trị trước đó trong <code>buffer</code>. Sau đó, với mỗi cặp, chúng ta nhân các giá trị với nhau, cộng tất cả kết quả, và dịch các bit trong tổng lên phải <code>qlp_shift</code> bit.</p>
<p>Các phép tính trong các ứng dụng như bộ giải mã audio thường ưu tiên hiệu năng hàng đầu. Ở đây, chúng ta tạo một iterator, sử dụng hai adaptor, và sau đó tiêu thụ giá trị. Mã assembly mà Rust biên dịch ra từ đoạn mã này sẽ như thế nào? Tính đến thời điểm hiện tại, nó được biên dịch xuống cùng mã assembly mà bạn có thể viết tay. Không hề có vòng lặp tương ứng với việc lặp qua các giá trị trong <code>coefficients</code>: Rust biết có 12 lần lặp, nên nó <em>“unroll”</em> vòng lặp. <em>Unrolling</em> là một tối ưu loại bỏ chi phí overhead của mã điều khiển vòng lặp và thay vào đó tạo mã lặp lại cho từng lần lặp.</p>
<p>Tất cả các hệ số được lưu trong các thanh ghi, nghĩa là truy cập giá trị rất nhanh. Không có kiểm tra ranh giới mảng tại runtime. Tất cả các tối ưu hóa mà Rust áp dụng giúp mã kết quả cực kỳ hiệu quả. Bây giờ bạn đã hiểu điều này, bạn có thể sử dụng iterators và closures mà không lo lắng! Chúng khiến mã trông cao cấp hơn nhưng không gây ra bất kỳ phạt hiệu năng nào tại runtime.</p>
<h2 id="tóm-tắt"><a class="header" href="#tóm-tắt">Tóm tắt</a></h2>
<p>Closures và iterators là các tính năng của Rust được lấy cảm hứng từ các ngôn ngữ lập trình hàm. Chúng giúp Rust thể hiện rõ ràng các ý tưởng cao cấp với hiệu năng cấp thấp. Cách triển khai closures và iterators được thiết kế sao cho hiệu năng runtime không bị ảnh hưởng. Đây là một phần trong mục tiêu của Rust nhằm cung cấp các <em>zero-cost abstractions</em>.</p>
<p>Bây giờ, sau khi chúng ta đã cải thiện khả năng biểu đạt trong dự án I/O, hãy cùng xem một số tính năng khác của <code>cargo</code> sẽ giúp chúng ta chia sẻ dự án với thế giới.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch13-03-improving-our-io-project.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch14-00-more-about-cargo.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch13-03-improving-our-io-project.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch14-00-more-about-cargo.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="ferris.js"></script>



    </div>
    </body>
</html>

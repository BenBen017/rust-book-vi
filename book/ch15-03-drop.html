<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Running Code on Cleanup with the Drop Trait - The Rust Programming Language</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="ferris.css">
        <link rel="stylesheet" href="theme/2018-edition.css">
        <link rel="stylesheet" href="theme/semantic-notes.css">
        <link rel="stylesheet" href="theme/listing.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust Programming Language</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="chạy-code-khi-dọn-dẹp-với-trait-drop"><a class="header" href="#chạy-code-khi-dọn-dẹp-với-trait-drop">Chạy Code Khi Dọn Dẹp với Trait <code>Drop</code></a></h2>
<p>Trait thứ hai quan trọng với mẫu thiết kế smart pointer là <code>Drop</code>, cho phép
bạn tùy chỉnh những gì xảy ra khi một giá trị sắp ra khỏi phạm vi. Bạn có
thể cung cấp một triển khai cho trait <code>Drop</code> trên bất kỳ kiểu nào, và mã đó
có thể được dùng để giải phóng tài nguyên như file hoặc kết nối mạng.</p>
<p>Chúng ta giới thiệu <code>Drop</code> trong bối cảnh smart pointer vì chức năng của
trait <code>Drop</code> hầu như luôn được sử dụng khi triển khai smart pointer. Ví
dụ, khi một <code>Box&lt;T&gt;</code> bị drop, nó sẽ giải phóng không gian trên heap mà box
trỏ tới.</p>
<p>Trong một số ngôn ngữ, với một số kiểu, lập trình viên phải gọi mã để
giải phóng bộ nhớ hoặc tài nguyên mỗi khi họ sử dụng xong một thể hiện
của các kiểu đó. Ví dụ bao gồm file handles, sockets, hoặc locks. Nếu họ
quên, hệ thống có thể bị quá tải và crash. Trong Rust, bạn có thể chỉ định
rằng một đoạn mã cụ thể sẽ chạy bất cứ khi nào một giá trị ra khỏi phạm
vi, và compiler sẽ tự động chèn đoạn mã đó. Kết quả là bạn không cần lo
lắng về việc đặt mã dọn dẹp ở khắp nơi trong chương trình khi một thể
hiện của một kiểu cụ thể kết thúc — bạn vẫn sẽ không bị rò rỉ tài
nguyên!</p>
<p>Bạn chỉ định đoạn mã chạy khi một giá trị ra khỏi phạm vi bằng cách triển
khai trait <code>Drop</code>. Trait <code>Drop</code> yêu cầu bạn triển khai một phương thức tên
là <code>drop</code> nhận một mutable reference tới <code>self</code>. Để thấy khi nào Rust
gọi <code>drop</code>, chúng ta sẽ triển khai <code>drop</code> với các lệnh <code>println!</code> trước
để quan sát.</p>
<p>Listing 15-14 hiển thị một struct <code>CustomSmartPointer</code> mà chức năng tùy
chỉnh duy nhất là in ra <code>Dropping CustomSmartPointer!</code> khi thể hiện ra
khỏi phạm vi, để minh họa khi Rust chạy hàm <code>drop</code>.</p>
<p><span class="filename">Filename: src/main.rs</span></p>
<pre><pre class="playground"><code class="language-rust edition2024">struct CustomSmartPointer {
    data: String,
}

impl Drop for CustomSmartPointer {
    fn drop(&amp;mut self) {
        println!("Dropping CustomSmartPointer with data `{}`!", self.data);
    }
}

fn main() {
    let c = CustomSmartPointer {
        data: String::from("my stuff"),
    };
    let d = CustomSmartPointer {
        data: String::from("other stuff"),
    };
    println!("CustomSmartPointers created.");
}</code></pre></pre>
<p><span class="caption">Listing 15-14: Một struct <code>CustomSmartPointer</code> triển khai trait <code>Drop</code>, nơi chúng ta sẽ đặt code dọn dẹp</span></p>
<p>Trait <code>Drop</code> đã được bao gồm trong prelude, nên chúng ta không cần phải đưa
nó vào phạm vi. Chúng ta triển khai trait <code>Drop</code> trên <code>CustomSmartPointer</code>
và cung cấp một triển khai cho phương thức <code>drop</code> gọi <code>println!</code>. Thân
hàm <code>drop</code> là nơi bạn sẽ đặt bất kỳ logic nào mà bạn muốn chạy khi một
thể hiện của kiểu của bạn ra khỏi phạm vi. Ở đây chúng ta in ra một số
văn bản để trực quan minh họa khi Rust sẽ gọi <code>drop</code>.</p>
<p>Trong hàm <code>main</code>, chúng ta tạo hai thể hiện của <code>CustomSmartPointer</code> và
sau đó in ra <code>CustomSmartPointers created</code>. Ở cuối <code>main</code>, các thể hiện
của <code>CustomSmartPointer</code> sẽ ra khỏi phạm vi, và Rust sẽ gọi đoạn code
chúng ta đặt trong phương thức <code>drop</code>, in ra thông điệp cuối cùng. Lưu
ý rằng chúng ta không cần phải gọi phương thức <code>drop</code> một cách rõ ràng.</p>
<p>Khi chạy chương trình này, chúng ta sẽ thấy đầu ra như sau:</p>
<pre><code class="language-console">$ cargo run
   Compiling drop-example v0.1.0 (file:///projects/drop-example)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.60s
     Running `target/debug/drop-example`
CustomSmartPointers created.
Dropping CustomSmartPointer with data `other stuff`!
Dropping CustomSmartPointer with data `my stuff`!
</code></pre>
<p>Rust tự động gọi <code>drop</code> cho chúng ta khi các thể hiện ra khỏi phạm vi,
thực thi đoạn code mà chúng ta đã chỉ định. Các biến được drop theo thứ tự
ngược lại với thứ tự tạo ra, nên <code>d</code> được drop trước <code>c</code>. Mục đích của
ví dụ này là để cung cấp một hướng dẫn trực quan về cách hoạt động của
phương thức <code>drop</code>; thường thì bạn sẽ đặt code dọn dẹp mà kiểu của bạn
cần chạy thay vì một thông điệp in ra.</p>
<h3 id="drop-một-giá-trị-sớm-với-stdmemdrop"><a class="header" href="#drop-một-giá-trị-sớm-với-stdmemdrop">Drop một giá trị sớm với <code>std::mem::drop</code></a></h3>
<p>Thật không may, việc tắt chức năng <code>drop</code> tự động không đơn giản. Thông
thường, việc tắt <code>drop</code> không cần thiết; toàn bộ mục đích của trait
<code>Drop</code> là nó được thực hiện tự động. Tuy nhiên, đôi khi bạn có thể muốn
dọn dẹp một giá trị sớm. Một ví dụ là khi sử dụng smart pointer quản lý
lock: bạn có thể muốn buộc phương thức <code>drop</code> giải phóng lock để các
đoạn code khác trong cùng phạm vi có thể lấy lock. Rust không cho phép
bạn gọi trực tiếp phương thức <code>drop</code> của trait <code>Drop</code>; thay vào đó, bạn
phải gọi hàm <code>std::mem::drop</code> do thư viện chuẩn cung cấp nếu muốn buộc
một giá trị bị drop trước khi kết thúc phạm vi của nó.</p>
<p>Nếu chúng ta thử gọi phương thức <code>drop</code> của trait <code>Drop</code> một cách thủ
công bằng cách sửa hàm <code>main</code> từ Listing 15-14, như trong Listing 15-15,
chúng ta sẽ nhận được lỗi biên dịch:</p>
<p><span class="filename">Filename: src/main.rs</span></p>
<pre><code class="language-rust ignore does_not_compile"><span class="boring">struct CustomSmartPointer {
</span><span class="boring">    data: String,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl Drop for CustomSmartPointer {
</span><span class="boring">    fn drop(&amp;mut self) {
</span><span class="boring">        println!("Dropping CustomSmartPointer with data `{}`!", self.data);
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>fn main() {
    let c = CustomSmartPointer {
        data: String::from("some data"),
    };
    println!("CustomSmartPointer created.");
    c.drop();
    println!("CustomSmartPointer dropped before the end of main.");
}</code></pre>
<p><span class="caption">Listing 15-15: Thử gọi phương thức <code>drop</code> từ
trait <code>Drop</code> một cách thủ công để dọn dẹp sớm</span></p>
<p>Khi chúng ta cố gắng biên dịch đoạn code này, chúng ta sẽ nhận được lỗi sau:</p>
<pre><code class="language-console">$ cargo run
   Compiling drop-example v0.1.0 (file:///projects/drop-example)
error[E0040]: explicit use of destructor method
  --&gt; src/main.rs:16:7
   |
16 |     c.drop();
   |       ^^^^ explicit destructor calls not allowed
   |
help: consider using `drop` function
   |
16 |     drop(c);
   |     +++++ ~

For more information about this error, try `rustc --explain E0040`.
error: could not compile `drop-example` (bin "drop-example") due to 1 previous error
</code></pre>
<p>Thông báo lỗi này cho biết rằng chúng ta không được phép gọi <code>drop</code> một cách rõ ràng. Thông báo lỗi sử dụng thuật ngữ <em>destructor</em>, đây là thuật ngữ lập trình chung để chỉ một hàm dọn dẹp một thể hiện. Một <em>destructor</em> tương tự như một <em>constructor</em>, nhưng thay vì tạo thể hiện thì nó dọn dẹp thể hiện đó. Hàm <code>drop</code> trong Rust là một destructor cụ thể.</p>
<p>Rust không cho phép chúng ta gọi <code>drop</code> trực tiếp vì Rust vẫn sẽ tự động gọi <code>drop</code> trên giá trị vào cuối <code>main</code>. Điều này sẽ gây ra lỗi <em>double free</em> vì Rust sẽ cố gắng dọn dẹp cùng một giá trị hai lần.</p>
<p>Chúng ta không thể vô hiệu hóa việc chèn tự động <code>drop</code> khi một giá trị ra khỏi phạm vi, và cũng không thể gọi phương thức <code>drop</code> một cách rõ ràng. Vì vậy, nếu cần ép một giá trị được dọn dẹp sớm, chúng ta sử dụng hàm <code>std::mem::drop</code>.</p>
<p>Hàm <code>std::mem::drop</code> khác với phương thức <code>drop</code> trong trait <code>Drop</code>. Chúng ta gọi nó bằng cách truyền giá trị muốn ép dọn dẹp làm đối số. Hàm này có sẵn trong prelude, vì vậy chúng ta có thể chỉnh sửa <code>main</code> trong Listing 15-15 để gọi hàm <code>drop</code>, như minh họa trong Listing 15-16:</p>
<p><span class="filename">Filename: src/main.rs</span></p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">struct CustomSmartPointer {
</span><span class="boring">    data: String,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl Drop for CustomSmartPointer {
</span><span class="boring">    fn drop(&amp;mut self) {
</span><span class="boring">        println!("Dropping CustomSmartPointer with data `{}`!", self.data);
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>fn main() {
    let c = CustomSmartPointer {
        data: String::from("some data"),
    };
    println!("CustomSmartPointer created.");
    drop(c);
    println!("CustomSmartPointer dropped before the end of main.");
}</code></pre></pre>
<p><span class="caption">Listing 15-16: Gọi <code>std::mem::drop</code> để dọn dẹp một giá trị một cách rõ ràng trước khi nó ra khỏi phạm vi</span></p>
<p>Chạy đoạn mã này sẽ in ra kết quả sau:</p>
<pre><code class="language-console">$ cargo run
   Compiling drop-example v0.1.0 (file:///projects/drop-example)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.73s
     Running `target/debug/drop-example`
CustomSmartPointer created.
Dropping CustomSmartPointer with data `some data`!
CustomSmartPointer dropped before the end of main.
</code></pre>
<p>Văn bản <code>Dropping CustomSmartPointer with data `some data`!</code> được in ra
giữa các thông báo <code>CustomSmartPointer created.</code> và <code>CustomSmartPointer dropped before the end of main.</code>,
cho thấy mã trong phương thức <code>drop</code> được gọi để hủy <code>c</code> tại thời điểm đó.</p>
<p>Bạn có thể sử dụng mã được xác định trong phần triển khai trait <code>Drop</code> theo nhiều cách
để làm cho việc dọn dẹp thuận tiện và an toàn: ví dụ, bạn có thể dùng nó để tạo bộ
cấp phát bộ nhớ riêng! Với trait <code>Drop</code> và hệ thống ownership của Rust, bạn không cần phải nhớ để dọn dẹp vì Rust sẽ tự động làm điều đó.</p>
<p>Bạn cũng không cần phải lo lắng về các vấn đề phát sinh từ việc vô tình dọn dẹp các
giá trị vẫn đang được sử dụng: hệ thống ownership đảm bảo các tham chiếu luôn hợp lệ
cũng đảm bảo rằng <code>drop</code> chỉ được gọi một lần khi giá trị không còn được sử dụng.</p>
<p>Bây giờ, sau khi đã xem xét <code>Box&lt;T&gt;</code> và một số đặc điểm của smart pointer, hãy cùng
tìm hiểu một vài smart pointer khác được định nghĩa trong thư viện chuẩn.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch15-02-deref.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch15-04-rc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch15-02-deref.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch15-04-rc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="ferris.js"></script>



    </div>
    </body>
</html>
